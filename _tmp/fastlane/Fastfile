# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
# https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
# https://docs.fastlane.tools/plugins/available-plugins

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# fastlane ios sort_out_certificates
platform :ios do
  	desc "Build iOS"
	lane :sort_out_certificates do

		# Notes:
		# ref: http://shashikantjagtap.net/ios-code-signing-5-signing-ios-app/

		# "get_certificates" will:
		# - Create a new private key
		# - Create a new signing request (CSR)
		# - Generate, downloads and installs the certificate
		# - Import all the generated files into your Keychain

	  	get_certificates(	# invokes cert
			generate_apple_certs: true,
			development: true,
			type: "iOS App Development",
			username: "badsprad@icloud.com",
			default_platform: "ios",
			platform: "ios",
			force: false
	  	)
	end

	lane :sort_out_provisioning do

		# sigh(force: true)
		get_provisioning_profile( 	# invokes sigh
			developer_id: true,
			development: true,
			force: false,
			username: "badsprad@icloud.com",
			# app_identifier: ???
			platform: "ios"
		)
	end

	lane :build_my_app do

		#disable_automatic_code_signing

		build_app(
			skip_profile_detection: false,
			scheme: "MyTestApp",
			workspace: "MyTestApp.xcworkspace",
			export_method: 'development', 
			export_options: {'signingStyle' => 'manual', 
				provisioningProfiles: { "com.testapp.domain" => "Testapp_profile" }
			},
			codesigning_identity: "iPhone Developer",
			configuration: "Development",
			output_directory: "../../../_tmp/fastlane", # Destination directory. Defaults to current directory.
			output_name: "my-test-app.ipa",       # specify the name of the .ipa file to generate (including file extension)
		)
	end

	lane :upload_my_app do
		## NOTE:
		# Use an Application Specific Password to upload
		##
		upload_to_testflight(
			skip_submission: true, 		# to only upload the build
			beta_app_feedback_email: "support@email.com",
			beta_app_description: "This is a description of my app",
			demo_account_required: false,
			notify_external_testers: false,
			changelog: "This is my changelog of things that have changed in a log"
		)
	end

end
